###
### DO NOT MODIFY THIS FILE!
###
### This YAML was auto-generated from SourceBuildRelease
### To make changes, change the C# definition and rebuild its project
###

name: $(Date:yyyyMMdd)$(Rev:.r)

appendCommitMessageToRunName: false

parameters:
- name: dotnetMajorVersion
  displayName: Major .NET version being released
  type: string
  values:
  - 6.0
  - 7.0
  - 8.0

- name: releaseName
  displayName: Release name (e.g. ".NET 8.0 Preview 1")
  type: string

- name: releaseBranchName
  displayName: Release branch name (e.g. release/8.0.1xx-preview1)
  type: string

- name: isPreviewRelease
  displayName: Preview release
  type: boolean
  default: false

- name: useCustomTag
  displayName: Use custom tag
  type: boolean
  default: false

- name: customTag
  displayName: Custom release tag (e.g. v6.0.XYY-source-build)
  type: string
  default: ' '

- name: useSpecificPipelineRunIDs
  displayName: Use specific pipeline run IDs
  type: boolean
  default: false

- name: dotnetDotnetRunID
  displayName: '[⚠️ 8.0] Specific dotnet-dotnet run name'
  type: string
  default: 202XXXXX.Y

- name: dotnetInstallerOfficialRunID
  displayName: '[⚠️ 6.0 / 7.0] Specific dotnet-installer-official-ci run name'
  type: string
  default: 202XXXXX.Y

- name: dotnetInstallerTarballBuildRunID
  displayName: '[⚠️ 6.0 / 7.0] Specific dotnet-installer-source-build-tarball-build run name'
  type: string
  default: 202XXXXX.Y

- name: verifyBuildSuccess
  displayName: Verify that associated pipeline runs succeeded
  type: boolean
  default: true

- name: createReleaseAnnouncement
  displayName: Create release announcement
  type: boolean
  default: true

- name: announcementGist
  displayName: Release announcement gist URL
  type: string
  default: ' '

- name: submitReleasePR
  displayName: Submit release PR
  type: boolean
  default: true

- name: createGitHubRelease
  displayName: '[⚠️ 8.0] Create tag & release in dotnet/dotnet'
  type: string
  default: auto
  values:
  - auto
  - skip
  - draft
  - full

- name: skipPackageMirroring
  displayName: Skip package mirroring
  type: boolean
  default: false

- name: isDryRun
  displayName: Dry run
  type: boolean
  default: false

trigger: none

pr: none

resources:
  pipelines:
  - pipeline: dotnet-staging-pipeline-resource
    source: Stage-DotNet
  repositories:
  - repository: dotnet-dotnet
    type: git
    name: dotnet-dotnet
    ref: main

pool:
  name: NetCore1ESPool-Svc-Internal
  demands:
  - ImageOverride -equals 1es-ubuntu-2004

stages:
- template: templates/stages/pre-release.yml
  parameters:
    dotnetMajorVersion: ${{ parameters.dotnetMajorVersion }}
    isPreviewRelease: ${{ parameters.isPreviewRelease }}
    releaseBranchName: ${{ parameters.releaseBranchName }}
    releaseName: ${{ parameters.releaseName }}
    useSpecificPipelineRunIDs: ${{ parameters.useSpecificPipelineRunIDs }}
    dotnetDotnetRunID: ${{ parameters.dotnetDotnetRunID }}
    dotnetInstallerOfficialRunID: ${{ parameters.dotnetInstallerOfficialRunID }}
    dotnetInstallerTarballBuildRunID: ${{ parameters.dotnetInstallerTarballBuildRunID }}
    verifyBuildSuccess: ${{ parameters.verifyBuildSuccess }}
    useCustomTag: ${{ parameters.useCustomTag }}
    isDryRun: ${{ parameters.isDryRun }}
    dotnetStagingPipelineResource: dotnet-staging-pipeline-resource
    customTag: ${{ replace(parameters.customTag, ' ', '') }}

- stage: MirrorApproval
  displayName: Ready for dotnet-security-partners mirroring
  dependsOn:
  - PreRelease
  jobs:
  - deployment: MirrorApproval
    displayName: Ready for dotnet-security-partners mirroring
    pool: server
    environment:
      name: Source Build Release - Mirror

- template: templates/stages/mirror.yml
  parameters:
    dotnetMajorVersion: ${{ parameters.dotnetMajorVersion }}
    isPreviewRelease: ${{ parameters.isPreviewRelease }}
    releaseBranchName: ${{ parameters.releaseBranchName }}
    useCustomTag: ${{ parameters.useCustomTag }}
    skipPackageMirroring: ${{ parameters.skipPackageMirroring }}
    isDryRun: ${{ parameters.isDryRun }}
    dotnetStagingPipelineResource: dotnet-staging-pipeline-resource

- stage: NotificationApproval
  displayName: Confirm partner notification sent
  dependsOn:
  - Mirror
  jobs:
  - deployment: NotificationApproval
    displayName: Confirm partner notification sent
    pool: server
    environment:
      name: Approval - Partner notification

- stage: ReleaseApproval
  displayName: Confirm Microsoft build released
  dependsOn:
  - NotificationApproval
  jobs:
  - deployment: ReleaseApproval
    displayName: Confirm Microsoft build released
    pool: server
    environment:
      name: Source Build Release - Release

- template: templates/stages/release.yml
  parameters:
    dotnetMajorVersion: ${{ parameters.dotnetMajorVersion }}
    isPreviewRelease: ${{ parameters.isPreviewRelease }}
    releaseBranchName: ${{ parameters.releaseBranchName }}
    releaseName: ${{ parameters.releaseName }}
    createReleaseAnnouncement: ${{ parameters.createReleaseAnnouncement }}
    createGitHubRelease: ${{ parameters.createGitHubRelease }}
    submitReleasePR: ${{ parameters.submitReleasePR }}
    isDryRun: ${{ parameters.isDryRun }}
    dotnetStagingPipelineResource: dotnet-staging-pipeline-resource
    announcementGist: ${{ replace(parameters.announcementGist, ' ', '') }}
